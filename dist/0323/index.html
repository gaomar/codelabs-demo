
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>Alexaã‚¹ã‚­ãƒ«é–‹ç™ºãƒãƒ³ã‚ºã‚ªãƒ³ ï½S3ã‚’ç¹‹ã’ã¦APLå¯¾å¿œã‚¹ã‚­ãƒ«ã‚’ä½œã‚ã†!ï½</title>
  <script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  <link rel="import" href="../../elements/codelab.html">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <style is="custom-style">
    body {
      font-family: "Roboto",sans-serif;
      background: var(--google-codelab-background, #F8F9FA);
    }
  </style>
  
</head>
<body unresolved class="fullbleed">

  <google-codelab title="Alexaã‚¹ã‚­ãƒ«é–‹ç™ºãƒãƒ³ã‚ºã‚ªãƒ³ ï½S3ã‚’ç¹‹ã’ã¦APLå¯¾å¿œã‚¹ã‚­ãƒ«ã‚’ä½œã‚ã†!ï½"
                  environment="web"
                  feedback-link="">
    
      <google-codelab-step label="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹" duration="0">
        <p>æ–°è¦ã‚¹ã‚­ãƒ«ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã¡ã‚‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚<br><a href="https://developer.amazon.com/ja/alexa-skills-kit" target="_blank">https://developer.amazon.com/ja/alexa-skills-kit</a></p>
<h2>1-1. ã‚¹ã‚­ãƒ«é–‹ç™ºã‚’å§‹ã‚ã‚ˆã†ï¼</h2>
<p>ï¼»ã‚¹ã‚­ãƒ«é–‹ç™ºã‚’å§‹ã‚ã‚‹ï¼½ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<p><img alt="s100" src="img/b271f296a74176d1.png"></p>
<p>Amazonã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚</p>
<p><img alt="s101" src="img/2edc81633369d120.png"></p>
<p>ï¼»ã‚¹ã‚­ãƒ«ã®ä½œæˆï¼½ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<p><img alt="s102" src="img/8533ffd0f4d85bf8.png"></p>
<p>ã‚¹ã‚­ãƒ«åã€Œãƒ¡ãƒ¢ã‚¹ã‚­ãƒ«ã€ã‚’å…¥åŠ›ã—ã¦ã€ï¼»ã‚«ã‚¹ã‚¿ãƒ ï¼½ã¨ï¼»AlexaãŒãƒ›ã‚¹ãƒˆï¼½ã‚’ãã‚Œãã‚Œé¸æŠã—ã¾ã™ã€‚<br>æœ€å¾Œã«ï¼»ã‚¹ã‚­ãƒ«ã‚’ä½œæˆï¼½ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<p><img alt="s103" src="img/7f4eae6e08da59ca.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="ã‚¹ãƒ­ãƒƒãƒˆã¨ã‚¤ãƒ³ãƒ†ãƒ³ãƒˆã‚’ä½œæˆã—ã‚ˆã†ï¼" duration="0">
        <h2>2-1. ã‚¹ãƒ­ãƒƒãƒˆã‚’ä½œæˆã™ã‚‹</h2>
<p>ãƒ¡ãƒ¢ã‚’ã‚»ãƒ¼ãƒ–ã¨ãƒ­ãƒ¼ãƒ‰ã®ã‚¹ãƒ­ãƒƒãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚å·¦å´ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã‚¹ãƒ­ãƒƒãƒˆã‚¿ã‚¤ãƒ—ã«ã‚ã‚‹ï¼»è¿½åŠ ï¼½ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<p>ã€ŒMemoSlotã€ã¨å…¥åŠ›ã—ã¦ï¼»ã‚«ã‚¹ã‚¿ãƒ ã‚¹ãƒ­ãƒƒãƒˆã‚¿ã‚¤ãƒ—ã‚’ä½œæˆï¼½ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<p><img alt="s105" src="img/de790a037289952.png"></p>
<p>ã€Œãƒ¡ãƒ¢ã‚’ã‚»ãƒ¼ãƒ–ã€ã‚„ã€Œãƒ¡ãƒ¢ã‚’ãƒ­ãƒ¼ãƒ‰ã€ã¨ã„ã†è¨€è‘‰ã«åå¿œã•ã›ãŸã„ã®ã§ã€ã‚»ãƒ¼ãƒ–ã¨ãƒ­ãƒ¼ãƒ‰ã‚’ãã‚Œãã‚Œç™»éŒ²ã—ã¾ã™ã€‚åŒç¾©èªã«ãã‚Œä»¥å¤–ã®è¨€è‘‰ã‚‚ç™»éŒ²ã—ã¦ãŠãã¾ã™ã€‚</p>
<p><img alt="s106" src="img/d8ceaeeebab8dfce.png"></p>
<h2>2-2. ã‚¤ãƒ³ãƒ†ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹</h2>
<p>MainIntentã‚’ä½œæˆã—ã¾ã™ã€‚å·¦å´ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã‚¤ãƒ³ãƒ†ãƒ³ãƒˆã«ã‚ã‚‹ï¼»è¿½åŠ ï¼½ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<p>ã€ŒMainIntentã€ã¨å…¥åŠ›ã—ã¦ï¼»ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ³ãƒ†ãƒ³ãƒˆã‚’ä½œæˆï¼½ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<p><img alt="s107" src="img/8b91e44ad351e7b6.png"></p>
<p>ã‚¤ãƒ³ãƒ†ãƒ³ãƒˆã‚¹ãƒ­ãƒƒãƒˆã‚’è¿½åŠ ã—ã¾ã™ã€‚<code>any</code>ã¨å…¥åŠ›ã—ã¦ï¼»ï¼‹ï¼½ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰<code>AMAZON.SearchQuery</code>ã‚’é¸æŠã—ã¾ã™ã€‚ï¼»ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ç·¨é›†ï¼½ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<p><img alt="s108" src="img/96a17cd296f3cecf.png"></p>
<p>å¿…é ˆå…¥åŠ›ã‚’<code>æ</code>œ‰åŠ¹åŒ–ã«ã—ã¾ã™ã€‚Alexaã®éŸ³å£°ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆéƒ¨åˆ†ã«ã€Œãƒ¡ãƒ¢ã™ã‚‹å†…å®¹ã‚’è¨€ã£ã¦ãã ã•ã„ã€‚ã€ã¨å…¥åŠ›ã—ã¾ã™ã€‚</p>
<p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè©±éƒ¨åˆ†ã¯<code>{any}</code>ã¨å…¥åŠ›ã—ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç™ºè©±ã—ãŸã‚‰anyã«æ ¼ç´ã•ã‚Œã¾ã™ã€‚</p>
<p><img alt="s109" src="img/d718b8fadaaa7bb6.png"></p>
<p>MainIntentéƒ¨åˆ†ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€å…ƒã®ç”»é¢ã«æˆ»ã‚Šã¾ã™ã€‚</p>
<p><img alt="s110" src="img/557d78ea3db870f0.png"></p>
<p>ã€Œã‚ªãƒ¼ãƒˆãƒ‡ãƒªã‚²ãƒ¼ãƒˆã‚’ç„¡åŠ¹åŒ–ã€ã‚’ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰é¸æŠã—ã¾ã™ã€‚</p>
<p><img alt="s111" src="img/e85fda01d5860de.png"></p>
<p>ã€Œstatã€ã¨å…¥åŠ›ã—ã¦ï¼»ï¼‹ï¼½ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯å…ˆç¨‹ä½œæˆã—ãŸ<code>MemoSlot</code>ã‚’é¸æŠã—ã¾ã™ã€‚</p>
<p><img alt="s112" src="img/b8ad8b1b577ebdec.png"></p>
<p>ã‚µãƒ³ãƒ—ãƒ«ç™ºè©±ã«è€ƒãˆã‚‰ã‚Œã‚‹æ–‡ç« ã‚’ç™»éŒ²ã—ã¦ã„ãã¾ã™ã€‚</p>
<p>ã“ã‚Œã§ã€Œãƒ¡ãƒ¢ã‚’ã‚»ãƒ¼ãƒ–ã€ã‚„ã€Œãƒ¡ãƒ¢ã‚’ãƒ­ãƒ¼ãƒ‰ã€ã¨ã„ã†è¨€è‘‰ã«åå¿œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚</p>
<p><img alt="s113" src="img/807f2085ad2da65c.png"></p>
<p>æœ€å¾Œã«å¿…ãšã€Œä¿å­˜ã€ã¨ã€Œãƒ“ãƒ«ãƒ‰ã€ã‚’å®Ÿè¡Œã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚</p>
<p><img alt="s114" src="img/79c3fd94fb287e5.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Alexa-hostedã§ã‚¹ã‚­ãƒ«ã‚’ä½œã‚ã†" duration="0">
        <h2>3-1. S3ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’è¿½åŠ ã™ã‚‹</h2>
<p>ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚å·¦å´ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰<code>package.json</code>ã‚’é–‹ãã¾ã™ã€‚</p>
<p>S3ã®npmä¾å­˜é–¢ä¿‚ã‚’è¿½åŠ ã—ã¾ã™ã€‚</p>
<pre><code>&#34;ask-sdk-s3-persistence-adapter&#34;: &#34;^2.0.0&#34;
</code></pre>
<p><img alt="s115" src="img/a66c1eb28cae9887.png"></p>
<pre><code>{
  &#34;name&#34;: &#34;hello-world&#34;,
  &#34;version&#34;: &#34;0.9.0&#34;,
  &#34;description&#34;: &#34;alexa utility for quickly building skills&#34;,
  &#34;main&#34;: &#34;index.js&#34;,
  &#34;scripts&#34;: {
    &#34;test&#34;: &#34;echo \&#34;Error: no test specified\&#34; &amp;&amp; exit 1&#34;
  },
  &#34;author&#34;: &#34;Amazon Alexa&#34;,
  &#34;license&#34;: &#34;ISC&#34;,
  &#34;dependencies&#34;: {
    &#34;ask-sdk-core&#34;: &#34;^2.0.7&#34;,
    &#34;ask-sdk-model&#34;: &#34;^1.4.1&#34;,
    &#34;aws-sdk&#34;: &#34;^2.326.0&#34;,
    &#34;ask-sdk-s3-persistence-adapter&#34;: &#34;^2.0.0&#34;  // â†ã“ã‚Œã‚’è¿½åŠ 
  }
}
</code></pre>
<h2>3-2. index.jsãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã™ã‚‹</h2>
<p>ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ä¸­èº«ã‚’ç·¨é›†ã—ã¾ã™ã€‚<code>index.js</code>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã¾ã™ã€‚</p>
<p><img alt="s116" src="img/dbb0f2745f2acdfe.png"></p>
<p>ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸‹è¨˜ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>const Alexa = require(&#39;ask-sdk-core&#39;);

// 1. ask persistence adapterã®èª­ã¿è¾¼ã¿
const persistenceAdapter = require(&#39;ask-sdk-s3-persistence-adapter&#39;);

// 2. ã‚¹ã‚­ãƒ«ãƒ“ãƒ«ãƒ€ãƒ¼ã‚’ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã‚’ä½¿ç”¨ã—ã¦åˆæœŸåŒ–
const skillBuilder = Alexa.SkillBuilders.custom().withPersistenceAdapter(
    new persistenceAdapter.S3PersistenceAdapter({bucketName:process.env.S3_PERSISTENCE_BUCKET})
);

// ã‚¹ã‚­ãƒ«èµ·å‹•æ™‚
const LaunchRequestHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;LaunchRequest&#39;;
    },
    handle(handlerInput) {
        const speechText = &#39;ãƒ¡ãƒ¢ã‚’ä¿å­˜ã™ã‚‹å ´åˆã¯ã€Œãƒ¡ãƒ¢ã‚’ã‚»ãƒ¼ãƒ–ã€ã€‚ãƒ¡ãƒ¢ã‚’èãå ´åˆã¯ã€Œãƒ¡ãƒ¢ã‚’ãƒ­ãƒ¼ãƒ‰ã€ã¨è¨€ã£ã¦ãã ã•ã„ã€‚&#39;;
        return handlerInput.responseBuilder
            .speak(speechText)
            .reprompt(speechText)
            .getResponse();
    }
};

// ãƒ¡ãƒ¢ã‚’ä¿å­˜orèª­ã¿å–ã‚Šåˆ¤åˆ¥
const MainIntentHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;IntentRequest&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.intent.name === &#39;MainIntent&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.dialogState === &#39;STARTED&#39;;
    },
    async handle(handlerInput) {
        const intent = handlerInput.requestEnvelope.request.intent;
        const memoSlot = intent.slots.stat;
        var modeVal = &#39;&#39;;
        
        if (memoSlot.value !== null) {
            if (memoSlot.resolutions[&#34;resolutionsPerAuthority&#34;][0][&#34;status&#34;][&#34;code&#34;] === &#39;ER_SUCCESS_MATCH&#39;) {
                modeVal = memoSlot.resolutions[&#34;resolutionsPerAuthority&#34;][0][&#34;values&#34;][0][&#34;value&#34;][&#34;name&#34;];
                
                if (modeVal === &#39;save&#39;) {
                    // ãƒ¡ãƒ¢ã™ã‚‹å†…å®¹ã‚’èãã«è¡Œã
                    return handlerInput.responseBuilder.addDelegateDirective().getResponse();
                } else {
                    // S3ã‹ã‚‰ä¿å­˜ã—ã¦ã„ã‚‹ãƒ¡ãƒ¢ã‚’å–å¾—
                    const attributesManager = handlerInput.attributesManager;
                    const s3Attributes = await attributesManager.getPersistentAttributes() || {};
                    const items = s3Attributes.hasOwnProperty(&#39;memoList&#39;)? s3Attributes.memoList : [];
                    var speechText = &#39;&#39;;
                    var memoData = &#39;&#39;;
                    
                    if (items.length &gt; 0) {
                        items.forEach(function( value ) {
                             memoData += `ã€Œ${value.memo}ã€`;
                        });
                        speechText = `ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ¡ãƒ¢ã¯${items.length}ã¤ã‚ã‚Šã¾ã™ã€‚${memoData}ã§ã™ã€‚`;    
                    }
                    return handlerInput.responseBuilder
                        .speak(speechText)
                        .reprompt(speechText)
                        .getResponse();
                }
            }
        } 
        
    }
};

// ãƒ¡ãƒ¢ã™ã‚‹è¨€è‘‰ã‚’å–å¾—å®Œäº†
const MemoCompletedHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;IntentRequest&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.intent.name === &#39;MainIntent&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.dialogState === &#39;IN_PROGRESS&#39;;
    },
    async handle(handlerInput) {
        const intent = handlerInput.requestEnvelope.request.intent;
        const memoVal = intent.slots.any.value;
        const speechText = `ã€Œ${memoVal}ã€ã¨ãƒ¡ãƒ¢ã—ãŸã‚ˆ`;
        const uuid = getUniqueStr();
        const attributesManager = handlerInput.attributesManager;
        const s3Attributes = await attributesManager.getPersistentAttributes() || {};
        const memoList = s3Attributes.hasOwnProperty(&#39;memoList&#39;)? s3Attributes.memoList : [];
        
        let memoData = {
            &#34;uuid&#34;: uuid,
            &#34;memo&#34;: memoVal
        };
        memoList.push(memoData);
        
        const sendData = {
            &#34;memoList&#34;: memoList
        }
        attributesManager.setPersistentAttributes(sendData);
        await attributesManager.savePersistentAttributes();
    
        return handlerInput.responseBuilder
            .speak(speechText)
            .reprompt(speechText)
            .getResponse();
        
    }
};

// UUIDä½œæˆ
function getUniqueStr(myStrong){
    var strong = 1000;
    if (myStrong) strong = myStrong;
    return new Date().getTime().toString(16)  + Math.floor(strong*Math.random()).toString(16);
}

// ãƒ˜ãƒ«ãƒ—
const HelpIntentHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;IntentRequest&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.intent.name === &#39;AMAZON.HelpIntent&#39;;
    },
    handle(handlerInput) {
        const speechText = &#39;ãƒ¡ãƒ¢ã‚’ä¿å­˜ã™ã‚‹å ´åˆã¯ã€Œãƒ¡ãƒ¢ã‚’ã‚»ãƒ¼ãƒ–ã€ã€‚ãƒ¡ãƒ¢ã‚’èãå ´åˆã¯ã€Œãƒ¡ãƒ¢ã‚’ãƒ­ãƒ¼ãƒ‰ã€ã¨è¨€ã£ã¦ãã ã•ã„ã€‚ãã‚Œã§ã¯ã©ã†ãï¼&#39;;

        return handlerInput.responseBuilder
            .speak(speechText)
            .reprompt(speechText)
            .getResponse();
    }
};

// ã‚­ãƒ£ãƒ³ã‚»ãƒ«orçµ‚äº†ã¨ç™ºè©±ã•ã‚ŒãŸ
const CancelAndStopIntentHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;IntentRequest&#39;
            &amp;&amp; (handlerInput.requestEnvelope.request.intent.name === &#39;AMAZON.CancelIntent&#39;
                || handlerInput.requestEnvelope.request.intent.name === &#39;AMAZON.StopIntent&#39;);
    },
    handle(handlerInput) {
        const speechText = &#39;ãƒã‚¤ãƒã‚¤ï¼ã¾ãŸã­ï¼&#39;;
        return handlerInput.responseBuilder
            .speak(speechText)
            .getResponse();
    }
};

// ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ‡ã‚Œ
const SessionEndedRequestHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;SessionEndedRequest&#39;;
    },
    handle(handlerInput) {
        // Any cleanup logic goes here.
        return handlerInput.responseBuilder.getResponse();
    }
};

// ã‚¨ãƒ©ãƒ¼æ™‚
const ErrorHandler = {
    canHandle() {
        return true;
    },
    handle(handlerInput, error) {
        console.log(`~~~~ Error handled: ${error.message}`);
        const speechText = `ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã—ãŸ`;

        return handlerInput.responseBuilder
            .speak(speechText)
            .reprompt(speechText)
            .getResponse();
    }
};

// å„ç¨®Handlerã‚’ç™»éŒ²ã™ã‚‹
exports.handler = skillBuilder
    .addRequestHandlers(
        LaunchRequestHandler,
        HelpIntentHandler,
        MainIntentHandler,
        MemoCompletedHandler,
        CancelAndStopIntentHandler,
        SessionEndedRequestHandler)
    .addErrorHandlers(
        ErrorHandler)
    .lambda();

</code></pre>
<h2>3-3. ã‚¹ã‚­ãƒ«ã‚’å®Ÿè¡Œã—ã‚ˆã†ï¼</h2>
<p>ãƒ‡ãƒ—ãƒ­ã‚¤ãŒçµ‚ã‚ã£ãŸã‚‰ãƒ†ã‚¹ãƒˆã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ã‚¹ã‚­ãƒ«ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p>
<p>ã€Œé–‹ç™ºä¸­ã€ã«åˆ‡ã‚Šæ›¿ãˆã¦ã‹ã‚‰ã€Œãƒ¡ãƒ¢ã‚¹ã‚­ãƒ«ã‚’ã²ã‚‰ã„ã¦ã€ã¨å…¥åŠ›ã—ã¾ã™ã€‚</p>
<p><img alt="s117" src="img/5df746283e19ba42.png"></p>
<h2>3-4. S3ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã‚ˆã†ï¼</h2>
<p>ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿ã®å·¦ä¸‹ã«ã‚ã‚‹<code>Media storage: S3 [0.0/5GB]</code>ã¨ã„ã†ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<p><img alt="s118" src="img/8c5325fc2e25fe4.png"></p>
<p>ã™ã‚‹ã¨AWSã®S3ãƒšãƒ¼ã‚¸ãŒé–‹ãã¾ã™ã€‚ãã“ã«ãƒ¡ãƒ¢ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ã‚¹ã‚­ãƒ«ã‚’å†èµ·å‹•ã—ã¦ã‚‚ãƒ¡ãƒ¢ã‚’ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚</p>
<p><img alt="s119" src="img/f4ff7407ad560ec4.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="APLå¯¾å¿œã—ã‚ˆã†ï¼" duration="0">
        <h2>4-1. APLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã‚ˆã†ï¼</h2>
<p>APLã®ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ä½œæˆã™ã‚‹ãŸã‚ã«ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ–°è¦ã§ä½œæˆã—ã¾ã™ã€‚<br><br>Alexa-hostedã‚’ä½¿ãˆã°ã€ç°¡å˜ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
<p><code>ã‚³</code>ãƒ¼ãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚<code>lambdda</code>ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ã€å·¦ä¸Šã«ã‚ã‚‹æ–°è¦ä½œæˆã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<p><img alt="s120" src="img/48c53533f57833fb.png"></p>
<p><code>apl_memolist.json</code>ã¨ã„ã†åå‰ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚ï¼»Create Fileï¼½ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<p><img alt="s121" src="img/a190bd77567c6459.png"></p>
<p>å…¥åŠ›ã™ã‚‹å†…å®¹ã¯ã“ã¡ã‚‰ã§ã™ã€‚</p>
<pre><code>{
    &#34;type&#34;: &#34;APL&#34;,
    &#34;version&#34;: &#34;1.0&#34;,
    &#34;theme&#34;: &#34;dark&#34;,
    &#34;import&#34;: [
        {
            &#34;name&#34;: &#34;alexa-layouts&#34;,
            &#34;version&#34;: &#34;1.0.0&#34;
        }
    ],
    &#34;resources&#34;: [],
    &#34;styles&#34;: {},
    &#34;layouts&#34;: {
        &#34;MemoList&#34;: {
            &#34;parameters&#34;: [
                &#34;listData&#34;
            ],
            &#34;item&#34;: {
                &#34;type&#34;: &#34;Container&#34;,
                &#34;width&#34;: &#34;100vw&#34;,
                &#34;height&#34;: &#34;100vh&#34;,
                &#34;direction&#34;: &#34;column&#34;,
                &#34;item&#34;: {
                    &#34;type&#34;: &#34;Sequence&#34;,
                    &#34;grow&#34;: 1,
                    &#34;height&#34;: &#34;80vh&#34;,
                    &#34;scrollDirection&#34;: &#34;vertical&#34;,
                    &#34;paddingLeft&#34;: &#34;@marginLeft&#34;,
                    &#34;paddingRight&#34;: &#34;@marginRight&#34;,
                    &#34;data&#34;: &#34;${listData}&#34;,
                    &#34;numbered&#34;: true,
                    &#34;items&#34;: {
                        &#34;type&#34;: &#34;VerticalListItem&#34;,
                        &#34;primaryText&#34;: &#34;${data.memo}&#34;
                    }
                }
            }
        },
        &#34;VerticalListItem&#34;: {
            &#34;parameters&#34;: [
                &#34;primaryText&#34;
            ],
            &#34;item&#34;: {
                &#34;type&#34;: &#34;Container&#34;,
                &#34;direction&#34;: &#34;row&#34;,
                &#34;height&#34;: 125,
                &#34;width&#34;: &#34;100%&#34;,
                &#34;alignItems&#34;: &#34;center&#34;,
                &#34;separator&#34;: true,
                &#34;items&#34;: [
                    {
                        &#34;type&#34;: &#34;Text&#34;,
                        &#34;text&#34;: &#34;${ordinal}&#34;,
                        &#34;color&#34;: &#34;white&#34;,
                        &#34;spacing&#34;: &#34;5dp&#34;
                    },
                    {
                        &#34;type&#34;: &#34;Text&#34;,
                        &#34;text&#34;: &#34;${primaryText}&#34;,
                        &#34;color&#34;: &#34;white&#34;,
                        &#34;width&#34;: &#34;100vw&#34;,
                        &#34;spacing&#34;: &#34;5vw&#34;
                    }
                ]
            }
        }
    },
    &#34;mainTemplate&#34;: {
        &#34;parameters&#34;: [
            &#34;payload&#34;
        ],
        &#34;items&#34;: [
            {
                &#34;type&#34;: &#34;MemoList&#34;,
                &#34;listData&#34;: &#34;${payload.MemoSkill.memoList}&#34;
            }
        ]
    }
}
</code></pre>
<p>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—å¿˜ã‚Œãªã„ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚</p>
<p><img alt="s122" src="img/50bc29da340f99f7.png"></p>
<h2>4-2. APLã‚’é©ç”¨ã—ã‚ˆã†ï¼</h2>
<p>å…ˆç¨‹ä½œæˆã—ãŸjsonãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«é©ç”¨ã—ã¾ã™ã€‚<br><br>index.jsãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãæ›ãˆã¾ã™ã€‚</p>
<p>61è¡Œç›®ã«ã‚ã‚‹<code>addDirective</code>ã®documentã«jsonãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ã¾ã™ã€‚dataéƒ¨åˆ†ã«S3ã‹ã‚‰å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿å€¤ã‚’è¨­å®šã—ã¾ã™ã€‚</p>
<pre><code>const Alexa = require(&#39;ask-sdk-core&#39;);

// 1. ask persistence adapterã®èª­ã¿è¾¼ã¿
const persistenceAdapter = require(&#39;ask-sdk-s3-persistence-adapter&#39;);

// 2. ã‚¹ã‚­ãƒ«ãƒ“ãƒ«ãƒ€ãƒ¼ã‚’ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã‚’ä½¿ç”¨ã—ã¦åˆæœŸåŒ–
const skillBuilder = Alexa.SkillBuilders.custom().withPersistenceAdapter(
    new persistenceAdapter.S3PersistenceAdapter({bucketName:process.env.S3_PERSISTENCE_BUCKET})
);

// ã‚¹ã‚­ãƒ«èµ·å‹•æ™‚
const LaunchRequestHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;LaunchRequest&#39;;
    },
    handle(handlerInput) {
        const speechText = &#39;ãƒ¡ãƒ¢ã‚’ä¿å­˜ã™ã‚‹å ´åˆã¯ã€Œãƒ¡ãƒ¢ã‚’ã‚»ãƒ¼ãƒ–ã€ã€‚ãƒ¡ãƒ¢ã‚’èãå ´åˆã¯ã€Œãƒ¡ãƒ¢ã‚’ãƒ­ãƒ¼ãƒ‰ã€ã¨è¨€ã£ã¦ãã ã•ã„ã€‚&#39;;
        return handlerInput.responseBuilder
            .speak(speechText)
            .reprompt(speechText)
            .getResponse();
    }
};

// ãƒ¡ãƒ¢ã‚’ä¿å­˜orèª­ã¿å–ã‚Šåˆ¤åˆ¥
const MainIntentHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;IntentRequest&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.intent.name === &#39;MainIntent&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.dialogState === &#39;STARTED&#39;;
    },
    async handle(handlerInput) {
        const intent = handlerInput.requestEnvelope.request.intent;
        const memoSlot = intent.slots.stat;
        var modeVal = &#39;&#39;;
        
        if (memoSlot.value !== null) {
            if (memoSlot.resolutions[&#34;resolutionsPerAuthority&#34;][0][&#34;status&#34;][&#34;code&#34;] === &#39;ER_SUCCESS_MATCH&#39;) {
                modeVal = memoSlot.resolutions[&#34;resolutionsPerAuthority&#34;][0][&#34;values&#34;][0][&#34;value&#34;][&#34;name&#34;];
                
                if (modeVal === &#39;save&#39;) {
                    // ãƒ¡ãƒ¢ã™ã‚‹å†…å®¹ã‚’èãã«è¡Œã
                    return handlerInput.responseBuilder.addDelegateDirective().getResponse();
                } else {
                    // S3ã‹ã‚‰ä¿å­˜ã—ã¦ã„ã‚‹ãƒ¡ãƒ¢ã‚’å–å¾—
                    const attributesManager = handlerInput.attributesManager;
                    const s3Attributes = await attributesManager.getPersistentAttributes() || {};
                    const items = s3Attributes.hasOwnProperty(&#39;memoList&#39;)? s3Attributes.memoList : [];
                    var speechText = &#39;&#39;;
                    var memoData = &#39;&#39;;
                    
                    if (items.length &gt; 0) {
                        items.forEach(function( value ) {
                             memoData += `ã€Œ${value.memo}ã€`;
                        });
                        speechText = `ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ¡ãƒ¢ã¯${items.length}ã¤ã‚ã‚Šã¾ã™ã€‚${memoData}ã§ã™ã€‚`;    
                    }
                    return handlerInput.responseBuilder
                        .speak(speechText)
                        .reprompt(speechText)
                        .addDirective({
                            type : &#39;Alexa.Presentation.APL.RenderDocument&#39;,
                            version: &#39;1.0&#39;,
                            token: &#34;token&#34;,
                            document: require(&#39;./apl_memolist.json&#39;),
                            datasources: {
                                &#34;MemoSkill&#34;: {
                                    &#34;memoList&#34;: items
                                }
                            }
                        })            
                        .getResponse();
                }
            }
        } 
        
    }
};

// ãƒ¡ãƒ¢ã™ã‚‹è¨€è‘‰ã‚’å–å¾—å®Œäº†
const MemoCompletedHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;IntentRequest&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.intent.name === &#39;MainIntent&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.dialogState === &#39;IN_PROGRESS&#39;;
    },
    async handle(handlerInput) {
        const intent = handlerInput.requestEnvelope.request.intent;
        const memoVal = intent.slots.any.value;
        const speechText = `ã€Œ${memoVal}ã€ã¨ãƒ¡ãƒ¢ã—ãŸã‚ˆ`;
        const uuid = getUniqueStr();
        const attributesManager = handlerInput.attributesManager;
        const s3Attributes = await attributesManager.getPersistentAttributes() || {};
        const memoList = s3Attributes.hasOwnProperty(&#39;memoList&#39;)? s3Attributes.memoList : [];
        
        let memoData = {
            &#34;uuid&#34;: uuid,
            &#34;memo&#34;: memoVal
        };
        memoList.push(memoData);
        
        const sendData = {
            &#34;memoList&#34;: memoList
        }
        attributesManager.setPersistentAttributes(sendData);
        await attributesManager.savePersistentAttributes();
    
        return handlerInput.responseBuilder
            .speak(speechText)
            .reprompt(speechText)
            .getResponse();
        
    }
};

// UUIDä½œæˆ
function getUniqueStr(myStrong){
    var strong = 1000;
    if (myStrong) strong = myStrong;
    return new Date().getTime().toString(16)  + Math.floor(strong*Math.random()).toString(16);
}

// ãƒ˜ãƒ«ãƒ—
const HelpIntentHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;IntentRequest&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.intent.name === &#39;AMAZON.HelpIntent&#39;;
    },
    handle(handlerInput) {
        const speechText = &#39;ãƒ¡ãƒ¢ã‚’ä¿å­˜ã™ã‚‹å ´åˆã¯ã€Œãƒ¡ãƒ¢ã‚’ã‚»ãƒ¼ãƒ–ã€ã€‚ãƒ¡ãƒ¢ã‚’èãå ´åˆã¯ã€Œãƒ¡ãƒ¢ã‚’ãƒ­ãƒ¼ãƒ‰ã€ã¨è¨€ã£ã¦ãã ã•ã„ã€‚ãã‚Œã§ã¯ã©ã†ãï¼&#39;;

        return handlerInput.responseBuilder
            .speak(speechText)
            .reprompt(speechText)
            .getResponse();
    }
};

// ã‚­ãƒ£ãƒ³ã‚»ãƒ«orçµ‚äº†ã¨ç™ºè©±ã•ã‚ŒãŸ
const CancelAndStopIntentHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;IntentRequest&#39;
            &amp;&amp; (handlerInput.requestEnvelope.request.intent.name === &#39;AMAZON.CancelIntent&#39;
                || handlerInput.requestEnvelope.request.intent.name === &#39;AMAZON.StopIntent&#39;);
    },
    handle(handlerInput) {
        const speechText = &#39;ãƒã‚¤ãƒã‚¤ï¼ã¾ãŸã­ï¼&#39;;
        return handlerInput.responseBuilder
            .speak(speechText)
            .getResponse();
    }
};

// ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ‡ã‚Œ
const SessionEndedRequestHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;SessionEndedRequest&#39;;
    },
    handle(handlerInput) {
        // Any cleanup logic goes here.
        return handlerInput.responseBuilder.getResponse();
    }
};

// ã‚¨ãƒ©ãƒ¼æ™‚
const ErrorHandler = {
    canHandle() {
        return true;
    },
    handle(handlerInput, error) {
        console.log(`~~~~ Error handled: ${error.message}`);
        const speechText = `ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã—ãŸ`;

        return handlerInput.responseBuilder
            .speak(speechText)
            .reprompt(speechText)
            .getResponse();
    }
};

// å„ç¨®Handlerã‚’ç™»éŒ²ã™ã‚‹
exports.handler = skillBuilder
    .addRequestHandlers(
        LaunchRequestHandler,
        HelpIntentHandler,
        MainIntentHandler,
        MemoCompletedHandler,
        CancelAndStopIntentHandler,
        SessionEndedRequestHandler)
    .addErrorHandlers(
        ErrorHandler)
    .lambda();

</code></pre>
<p>ï¼»Saveï¼½ã¨ï¼»Deployï¼½ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—å¿˜ã‚Œãªã„ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚</p>
<p><img alt="s123" src="img/cec20204647f68fa.png"></p>
<h2>4-3. ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ç¢ºèªã—ã‚ˆã†ï¼</h2>
<p>APLå¯¾å¿œã§ããŸã‹ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚ãƒ†ã‚¹ãƒˆã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ã‚¹ã‚­ãƒ«ã‚’èµ·å‹•ã—ã¾ã™ã€‚</p>
<p><img alt="s124" src="img/baa23aa03ec49159.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="ã‚¿ãƒƒãƒã«åå¿œã•ã›ã‚ˆã†ï¼" duration="0">
        <p>ç”»é¢ã‚¿ãƒƒãƒã—ã¦åå¿œã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚ä»Šå›ã¯ã‚¹ã‚­ãƒ«åˆå›èµ·å‹•æ™‚ã«SAVEãƒœã‚¿ãƒ³ã¨LOADãƒœã‚¿ãƒ³ã‚’è¨­ç½®ã—ã¦ã€æŠ¼ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã«å¿œã˜ã¦å‡¦ç†ã‚’å¤‰æ›´ã—ã¾ã™ã€‚</p>
<h2>5-1. ãƒˆãƒƒãƒ—ç”»é¢ã‚’ä½œã‚‹</h2>
<p>ã‚¹ã‚­ãƒ«èµ·å‹•ç›´å¾Œã«è¡¨ç¤ºã™ã‚‹ãƒˆãƒƒãƒ—ç”»é¢ã§ã™ã€‚<br><br>å˜ç´”ã«SAVEã¨LOADãƒœã‚¿ãƒ³ãŒè¨­ç½®ã—ã¦ã‚ã‚‹ã ã‘ã§ã™ã€‚</p>
<p>ã§ã¯ã€APLãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ–°è¦ä½œæˆã—ã¾ã™ã€‚ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆã—ã¾ã™ã€‚</p>
<p><img alt="s130" src="img/fa42407b849444c6.png"></p>
<p><code>apl_top.json</code>ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚</p>
<p><img alt="s131" src="img/1bef8145e7966e4d.png"></p>
<p>apl_top.jsonã®ä¸­èº«ã¯ä¸‹è¨˜ã‚’ã‚³ãƒ”ãƒšã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>{
    &#34;type&#34;: &#34;APL&#34;,
    &#34;version&#34;: &#34;1.0&#34;,
    &#34;theme&#34;: &#34;dark&#34;,
    &#34;import&#34;: [],
    &#34;resources&#34;: [],
    &#34;styles&#34;: {},
    &#34;layouts&#34;: {},
    &#34;mainTemplate&#34;: {
        &#34;parameters&#34;: [
            &#34;payload&#34;
        ],
        &#34;items&#34;: [
            {
                &#34;type&#34;: &#34;Container&#34;,
                &#34;direction&#34;: &#34;column&#34;,
                &#34;item&#34;: [
                    {
                        &#34;type&#34;: &#34;Text&#34;,
                        &#34;textAlign&#34;: &#34;center&#34;,
                        &#34;paddingTop&#34;: &#34;15vh&#34;,
                        &#34;text&#34;: &#34;ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠ&#34;
                    },
                    {
                        &#34;type&#34;: &#34;Container&#34;,
                        &#34;direction&#34;: &#34;row&#34;,
                        &#34;alignItems&#34;: &#34;center&#34;,
                        &#34;justifyContent&#34;: &#34;center&#34;,
                        &#34;width&#34;: &#34;100vw&#34;,
                        &#34;height&#34;: &#34;50vh&#34;,
                        &#34;paddingTop&#34;: &#34;10vh&#34;,
                        &#34;items&#34;: [
                            {
                                &#34;type&#34;: &#34;Container&#34;,
                                &#34;paddingRight&#34;: &#34;5vw&#34;,
                                &#34;item&#34;: [
                                    {
                                        &#34;type&#34;: &#34;TouchWrapper&#34;,
                                        &#34;onPress&#34;: {
                                            &#34;type&#34;: &#34;SendEvent&#34;,
                                            &#34;arguments&#34;: [
                                                &#34;save&#34;
                                            ]
                                        },
                                        &#34;item&#34;: [
                                            {
                                                &#34;type&#34;: &#34;Frame&#34;,
                                                &#34;borderRadius&#34;: 10,
                                                &#34;backgroundColor&#34;: &#34;blue&#34;,
                                                &#34;item&#34;: [
                                                    {
                                                        &#34;type&#34;: &#34;Text&#34;,
                                                        &#34;text&#34;: &#34;SAVE&#34;,
                                                        &#34;width&#34;: &#34;30vw&#34;,
                                                        &#34;height&#34;: &#34;20vh&#34;,
                                                        &#34;textAlign&#34;: &#34;center&#34;,
                                                        &#34;textAlignVertical&#34;: &#34;center&#34;
                                                    }
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            },
                            {
                                &#34;type&#34;: &#34;Container&#34;,
                                &#34;paddingLeft&#34;: &#34;5vw&#34;,
                                &#34;item&#34;: [
                                    {
                                        &#34;type&#34;: &#34;TouchWrapper&#34;,
                                        &#34;onPress&#34;: {
                                            &#34;type&#34;: &#34;SendEvent&#34;,
                                            &#34;arguments&#34;: [
                                                &#34;load&#34;
                                            ]
                                        },
                                        &#34;item&#34;: [
                                            {
                                                &#34;type&#34;: &#34;Frame&#34;,
                                                &#34;borderRadius&#34;: 10,
                                                &#34;backgroundColor&#34;: &#34;green&#34;,
                                                &#34;item&#34;: [
                                                    {
                                                        &#34;type&#34;: &#34;Text&#34;,
                                                        &#34;text&#34;: &#34;LOAD&#34;,
                                                        &#34;width&#34;: &#34;30vw&#34;,
                                                        &#34;height&#34;: &#34;20vh&#34;,
                                                        &#34;textAlign&#34;: &#34;center&#34;,
                                                        &#34;textAlignVertical&#34;: &#34;center&#34;
                                                    }
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        &#34;type&#34;: &#34;Text&#34;,
                        &#34;textAlign&#34;: &#34;center&#34;,
                        &#34;fontSize&#34;: &#34;4vw&#34;,
                        &#34;text&#34;: &#34;${payload.MemoSkill.hint}&#34;
                    }
                ]
            }
        ]
    }
}
</code></pre>
<p>APLã‚ªãƒ¼ã‚µãƒªãƒ³ã‚°ãƒ„ãƒ¼ãƒ«ã§è¦‹ã‚‹ã¨ã“ã®ã‚ˆã†ãªç”»é¢ã«ãªã‚Šã¾ã™ã€‚</p>
<p><img alt="s132" src="img/207b06a912114d0f.png"></p>
<h2>5-2. ä½¿ã„æ‰‹ã«ã‚ã‹ã‚Šã‚„ã™ãã™ã‚‹</h2>
<p>ä»Šã®ã¾ã¾ã ã¨ãƒœã‚¿ãƒ³æŠ¼ã—ãŸã‚ã¨ã«ã€SAVEã¨LOADãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚ŒãŸã¾ã¾ã«ãªã‚Šã¾ã™ã€‚<br><br>ãã‚Œã‚’é˜²ããŸã‚ã«ç”»é¢ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ã€æ¬¡ã«è¡Œã£ã¦ã‚‚ã‚‰ã†äº‹ã‚’ç”»é¢ä¸Šã«è¡¨ç¤ºã•ã›ã¾ã™ã€‚</p>
<p>æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆã—ã¦ãã ã•ã„ã€‚</p>
<p><img alt="s133" src="img/c961d5bc20bad93e.png"></p>
<p><code>apl_text.json</code>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚</p>
<p><img alt="s134" src="img/46469b970d4f6ad3.png"></p>
<p>ä¸‹è¨˜ã‚’ã‚³ãƒ”ãƒšã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>{
    &#34;type&#34;: &#34;APL&#34;,
    &#34;version&#34;: &#34;1.0&#34;,
    &#34;theme&#34;: &#34;dark&#34;,
    &#34;import&#34;: [],
    &#34;resources&#34;: [],
    &#34;styles&#34;: {},
    &#34;layouts&#34;: {},
    &#34;mainTemplate&#34;: {
        &#34;parameters&#34;: [
            &#34;payload&#34;
        ],
        &#34;items&#34;: [
            {
                &#34;type&#34;: &#34;Container&#34;,
                &#34;width&#34;: &#34;100vw&#34;,
                &#34;height&#34;: &#34;100vh&#34;,
                &#34;alignItems&#34;: &#34;center&#34;,
                &#34;direction&#34;: &#34;column&#34;,
                &#34;justifyContent&#34;: &#34;center&#34;,
                &#34;item&#34;: [
                    {
                        &#34;type&#34;: &#34;Text&#34;,
                        &#34;width&#34;: &#34;90vw&#34;,
                        &#34;textAlign&#34;: &#34;center&#34;,
                        &#34;fontSize&#34;: &#34;10vw&#34;,
                        &#34;text&#34;: &#34;${payload.MemoSkill.word}&#34;
                    }
                ]
            }
        ]
    }
}
</code></pre>
<p>APLã‚ªãƒ¼ã‚µãƒªãƒ³ã‚°ãƒ„ãƒ¼ãƒ«ã§è¦‹ã‚‹ã¨ã“ã®ã‚ˆã†ãªç”»é¢ã«ãªã‚Šã¾ã™ã€‚<br><code>${payload.MemoSkill.word}</code>éƒ¨åˆ†ã¯ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§å¯å¤‰ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚</p>
<p><img alt="s135" src="img/faa395f59c80c9f1.png"></p>
<h2>5-3. APLã‚’é©ç”¨ã™ã‚‹</h2>
<p>ä»Šã¾ã§ä½œæˆã—ãŸAPLã‚’é©ç”¨ã—ã¾ã™ã€‚step3.jsã®ä¸­èº«ã‚’ã‚³ãƒ”ãƒšã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>const Alexa = require(&#39;ask-sdk-core&#39;);

// 1. ask persistence adapterã®èª­ã¿è¾¼ã¿
const persistenceAdapter = require(&#39;ask-sdk-s3-persistence-adapter&#39;);

// 2. ã‚¹ã‚­ãƒ«ãƒ“ãƒ«ãƒ€ãƒ¼ã‚’ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã‚’ä½¿ç”¨ã—ã¦åˆæœŸåŒ–
const skillBuilder = Alexa.SkillBuilders.custom().withPersistenceAdapter(
    new persistenceAdapter.S3PersistenceAdapter({bucketName:process.env.S3_PERSISTENCE_BUCKET})
);

// ã‚¹ã‚­ãƒ«èµ·å‹•æ™‚
const LaunchRequestHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;LaunchRequest&#39;;
    },
    handle(handlerInput) {
        const speechText = &#39;ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚&#39;;
        return handlerInput.responseBuilder
            .speak(speechText)
            .addDirective({
                type : &#39;Alexa.Presentation.APL.RenderDocument&#39;,
                version: &#39;1.0&#39;,
                token: &#34;token&#34;,
                document: require(&#39;./apl_top.json&#39;),
                datasources: {
                    &#34;MemoSkill&#34;: {
                        &#34;hint&#34;: &#34;ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„&#34;
                    }
                }
            })            
            .getResponse();
    }
};

// ç”»é¢ã‚¿ãƒƒãƒå‡¦ç†
// ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ã¯onPressãŒåå¿œã—ã€å®Ÿæ©Ÿã§ã¯PressãŒåå¿œã™ã‚‹ãŸã‚2ã¤æ›¸ã„ã¦ãŠã
const TouchEventHandler = {
    canHandle(handlerInput) {
    return ((handlerInput.requestEnvelope.request.type === &#39;Alexa.Presentation.APL.UserEvent&#39; &amp;&amp;
        (handlerInput.requestEnvelope.request.source.handler === &#39;Press&#39; || 
        handlerInput.requestEnvelope.request.source.handler === &#39;onPress&#39;)));
    },
    async handle(handlerInput) {
        // TcouhWrapperã®argumentsã§æŒ‡å®šã—ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹
        const choice = handlerInput.requestEnvelope.request.arguments[0];

        if (choice === &#39;save&#39;) {
            return handlerInput.responseBuilder
                .speak(&#39;ãƒ¡ãƒ¢ã™ã‚‹è¨€è‘‰ã‚’è¨€ã£ã¦ãã ã•ã„ã€‚&#39;)
                .addDirective({
                    type : &#39;Alexa.Presentation.APL.RenderDocument&#39;,
                    version: &#39;1.0&#39;,
                    token: &#34;token&#34;,
                    document: require(&#39;./apl_text.json&#39;),
                    datasources: {
                        &#34;MemoSkill&#34;: {
                            &#34;word&#34;: &#34;ã€Œã‚¢ãƒ¬ã‚¯ã‚µã€â—‹â—‹ã¨ãƒ¡ãƒ¢ã—ã¦ã€ã¨è¨€ã£ã¦ãã ã•ã„ã€‚&#34; 
                        }
                    }
                })            
                .getResponse();

            
        }
            
        // S3ã‹ã‚‰ä¿å­˜ã—ã¦ã„ã‚‹ãƒ¡ãƒ¢ã‚’å–å¾—
        const attributesManager = handlerInput.attributesManager;
        const s3Attributes = await attributesManager.getPersistentAttributes() || {};
        const items = s3Attributes.hasOwnProperty(&#39;memoList&#39;)? s3Attributes.memoList : [];
        var speechText = &#39;&#39;;
        var memoData = &#39;&#39;;
        
        if (items.length &gt; 0) {
            items.forEach(function( value ) {
                 memoData += `ã€Œ${value.memo}ã€`;
            });
            speechText = `ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ¡ãƒ¢ã¯${items.length}ã¤ã‚ã‚Šã¾ã™ã€‚${memoData}ã§ã™ã€‚`;    
        }
        return handlerInput.responseBuilder
            .speak(speechText)
            .reprompt(speechText)
            .addDirective({
                type : &#39;Alexa.Presentation.APL.RenderDocument&#39;,
                version: &#39;1.0&#39;,
                token: &#34;token&#34;,
                document: require(&#39;./apl_memolist.json&#39;),
                datasources: {
                    &#34;MemoSkill&#34;: {
                        &#34;memoList&#34;: items
                    }
                }
            })            
            .getResponse();
    }
};

// ãƒ¡ãƒ¢ã‚’ä¿å­˜orèª­ã¿å–ã‚Šåˆ¤åˆ¥
const MainIntentHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;IntentRequest&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.intent.name === &#39;MainIntent&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.dialogState === &#39;STARTED&#39;;
    },
    async handle(handlerInput) {
        const intent = handlerInput.requestEnvelope.request.intent;
        const memoSlot = intent.slots.stat;
        var modeVal = &#39;&#39;;
        
        if (memoSlot.value !== null) {
            if (memoSlot.resolutions[&#34;resolutionsPerAuthority&#34;][0][&#34;status&#34;][&#34;code&#34;] === &#39;ER_SUCCESS_MATCH&#39;) {
                modeVal = memoSlot.resolutions[&#34;resolutionsPerAuthority&#34;][0][&#34;values&#34;][0][&#34;value&#34;][&#34;name&#34;];
                
                if (modeVal === &#39;save&#39;) {
                    // ãƒ¡ãƒ¢ã™ã‚‹å†…å®¹ã‚’èãã«è¡Œã
                    return handlerInput.responseBuilder.addDelegateDirective().getResponse();
                } else {
                    // S3ã‹ã‚‰ä¿å­˜ã—ã¦ã„ã‚‹ãƒ¡ãƒ¢ã‚’å–å¾—
                    const attributesManager = handlerInput.attributesManager;
                    const s3Attributes = await attributesManager.getPersistentAttributes() || {};
                    const items = s3Attributes.hasOwnProperty(&#39;memoList&#39;)? s3Attributes.memoList : [];
                    var speechText = &#39;&#39;;
                    var memoData = &#39;&#39;;
                    
                    if (items.length &gt; 0) {
                        items.forEach(function( value ) {
                             memoData += `ã€Œ${value.memo}ã€`;
                        });
                        speechText = `ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ¡ãƒ¢ã¯${items.length}ã¤ã‚ã‚Šã¾ã™ã€‚${memoData}ã§ã™ã€‚`;    
                    }
                    return handlerInput.responseBuilder
                        .speak(speechText)
                        .reprompt(speechText)
                        .addDirective({
                            type : &#39;Alexa.Presentation.APL.RenderDocument&#39;,
                            version: &#39;1.0&#39;,
                            token: &#34;token&#34;,
                            document: require(&#39;./apl_memolist.json&#39;),
                            datasources: {
                                &#34;MemoSkill&#34;: {
                                    &#34;memoList&#34;: items
                                }
                            }
                        })            
                        .getResponse();
                }
            }
        } 
        
    }
};

// ãƒ¡ãƒ¢ã™ã‚‹è¨€è‘‰ã‚’å–å¾—å®Œäº†
const MemoCompletedHandler = {
    canHandle(handlerInput) {
        return (handlerInput.requestEnvelope.request.type === &#39;IntentRequest&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.intent.name === &#39;MainIntent&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.dialogState === &#39;IN_PROGRESS&#39;) ||
            (handlerInput.requestEnvelope.request.type === &#39;IntentRequest&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.intent.name === &#39;SaveIntent&#39;);
    },
    async handle(handlerInput) {
        const intent = handlerInput.requestEnvelope.request.intent;
        const memoVal = intent.slots.any.value;
        const speechText = `ã€Œ${memoVal}ã€ã¨ãƒ¡ãƒ¢ã—ãŸã‚ˆ`;
        const uuid = getUniqueStr();
        const attributesManager = handlerInput.attributesManager;
        const s3Attributes = await attributesManager.getPersistentAttributes() || {};
        const memoList = s3Attributes.hasOwnProperty(&#39;memoList&#39;)? s3Attributes.memoList : [];
        
        let memoData = {
            &#34;uuid&#34;: uuid,
            &#34;memo&#34;: memoVal
        };
        memoList.push(memoData);
        
        const sendData = {
            &#34;memoList&#34;: memoList
        }
        attributesManager.setPersistentAttributes(sendData);
        await attributesManager.savePersistentAttributes();
    
        return handlerInput.responseBuilder
            .speak(speechText)
            .addDirective({
                type : &#39;Alexa.Presentation.APL.RenderDocument&#39;,
                version: &#39;1.0&#39;,
                token: &#34;token&#34;,
                document: require(&#39;./apl_top.json&#39;),
                datasources: {
                    &#34;MemoSkill&#34;: {
                        &#34;hint&#34;: speechText
                    }
                }
            })            
            .getResponse();
        
    }
};

// UUIDä½œæˆ
function getUniqueStr(myStrong){
    var strong = 1000;
    if (myStrong) strong = myStrong;
    return new Date().getTime().toString(16)  + Math.floor(strong*Math.random()).toString(16);
}

// ãƒ˜ãƒ«ãƒ—
const HelpIntentHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;IntentRequest&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.intent.name === &#39;AMAZON.HelpIntent&#39;;
    },
    handle(handlerInput) {
        const speechText = &#39;ãƒ¡ãƒ¢ã‚’ä¿å­˜ã™ã‚‹å ´åˆã¯ã€Œãƒ¡ãƒ¢ã‚’ã‚»ãƒ¼ãƒ–ã€ã€‚ãƒ¡ãƒ¢ã‚’èãå ´åˆã¯ã€Œãƒ¡ãƒ¢ã‚’ãƒ­ãƒ¼ãƒ‰ã€ã¨è¨€ã£ã¦ãã ã•ã„ã€‚ãã‚Œã§ã¯ã©ã†ãï¼&#39;;

        return handlerInput.responseBuilder
            .speak(speechText)
            .reprompt(speechText)
            .getResponse();
    }
};

// ã‚­ãƒ£ãƒ³ã‚»ãƒ«orçµ‚äº†ã¨ç™ºè©±ã•ã‚ŒãŸ
const CancelAndStopIntentHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;IntentRequest&#39;
            &amp;&amp; (handlerInput.requestEnvelope.request.intent.name === &#39;AMAZON.CancelIntent&#39;
                || handlerInput.requestEnvelope.request.intent.name === &#39;AMAZON.StopIntent&#39;);
    },
    handle(handlerInput) {
        const speechText = &#39;ãƒã‚¤ãƒã‚¤ï¼ã¾ãŸã­ï¼&#39;;
        return handlerInput.responseBuilder
            .speak(speechText)
            .getResponse();
    }
};

// ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ‡ã‚Œ
const SessionEndedRequestHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;SessionEndedRequest&#39;;
    },
    handle(handlerInput) {
        // Any cleanup logic goes here.
        return handlerInput.responseBuilder.getResponse();
    }
};

// ã‚¨ãƒ©ãƒ¼æ™‚
const ErrorHandler = {
    canHandle() {
        return true;
    },
    handle(handlerInput, error) {
        console.log(`~~~~ Error handled: ${error.message}`);
        const speechText = `ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã—ãŸ`;

        return handlerInput.responseBuilder
            .speak(speechText)
            .reprompt(speechText)
            .getResponse();
    }
};

// å„ç¨®Handlerã‚’ç™»éŒ²ã™ã‚‹
exports.handler = skillBuilder
    .addRequestHandlers(
        LaunchRequestHandler,
        HelpIntentHandler,
        MainIntentHandler,
        MemoCompletedHandler,
        TouchEventHandler,
        CancelAndStopIntentHandler,
        SessionEndedRequestHandler)
    .addErrorHandlers(
        ErrorHandler)
    .lambda();

</code></pre>
<h2>5-4. ãƒ¡ãƒ¢ä¿å­˜ç”¨Intentã‚’ä½œæˆã™ã‚‹</h2>
<p>APLã‹ã‚‰Dialogãƒ¢ãƒ¼ãƒ‰ã‚’åˆ¶å¾¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚<br><br>å°‚ç”¨ã®Intentã‚’ä½œæˆã—ã¦ã€ãã®Intentã‚’çµŒç”±ã—ã¦å®Ÿç¾ã—ã¾ã™ã€‚</p>
<p>ãƒ“ãƒ«ãƒ‰ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ã‚¤ãƒ³ãƒ†ãƒ³ãƒˆå´ã«ã‚ã‚‹ï¼»è¿½åŠ ï¼½ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<p><img alt="s140" src="img/7f278074d9235940.png"></p>
<p>è‡ªç”±ãƒ†ã‚­ã‚¹ãƒˆã‚’æ‰‹ã«å…¥ã‚Œã‚‹ãŸã‚ã«å¤‰æ•°å<code>any</code>ã‚’æŒ‡å®šã—ã¦ã€<code>AMAZON.SearchQuery</code>ã‚’é¸æŠã—ã¾ã™ã€‚<br><br>ã‚µãƒ³ãƒ—ãƒ«ç™ºè©±ã«3ç¨®é¡ã»ã©ç™»éŒ²ã—ã¦ã‹ã‚‰ã€ï¼»ä¿å­˜ï¼½ï¼»ãƒ“ãƒ«ãƒ‰ï¼½ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚</p>
<p><img alt="s141" src="img/4dc70b5d92951558.png"></p>
<h2>5-5. ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ç¢ºèªã™ã‚‹</h2>
<p>ãƒ†ã‚¹ãƒˆã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ç”»é¢ã«é·ç§»ã—ã¦ãã ã•ã„ã€‚<br><br>ã‚¹ã‚­ãƒ«ã‚’èµ·å‹•ã™ã‚‹ã¨SAVEã¨LOADãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€SAVEãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å‹•ä½œç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p>
<p><img alt="s142" src="img/1a8527bd3b1ada8f.png"></p>
<h2>5-6. ã¾ã¨ã‚</h2>
<p>APLã‚’ä½¿ãˆã°ç°¡å˜ã«ç”»é¢å¯¾å¿œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã‚¢ã‚¤ãƒ‡ã‚¢æ¬¡ç¬¬ã§æ§˜ã€…ãªã‚¹ã‚­ãƒ«ã‚’é–‹ç™ºã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§ã€ã©ã‚“ã©ã‚“APLã‚’ä½¿ã£ã¦ã„ãã¾ã—ã‚‡ã†ï¼</p>


      </google-codelab-step>
    
  </google-codelab>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-49880327-14', 'auto');

    (function() {
      var gaCodelab = '';
      if (gaCodelab) {
        ga('create', gaCodelab, 'auto', {name: 'codelab'});
      }

      var gaView;
      var parts = location.search.substring(1).split('&');
      for (var i = 0; i < parts.length; i++) {
        var param = parts[i].split('=');
        if (param[0] === 'viewga') {
          gaView = param[1];
          break;
        }
      }
      if (gaView && gaView !== gaCodelab) {
        ga('create', gaView, 'auto', {name: 'view'});
      }
    })();
  </script>

</body>
</html>
